\documentclass{beamer}
\usepackage[utf8]{inputenc}
\usepackage{xcolor}
\usepackage{enumitem}
\usepackage{listings}
\usepackage{tikz}
\usepackage{tikzsymbols}

\usetikzlibrary{shapes.geometric, shapes.symbols, arrows}
\tikzstyle{process} = [signal,  text width=1.5cm, minimum height=1.5cm,text centered, draw=black, fill=green!30]
\tikzstyle{maybe} = [signal,  text width=1.5cm, minimum height=1.5cm,text centered, draw=black ]
\tikzstyle{final} =  [rectangle, text width=1.5cm, minimum height=1.5cm,text centered, draw=black ]
\tikzstyle{arrow} = [thick,->,>=stealth]

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
  backgroundcolor=\color{backcolour},
  commentstyle=\color{codegreen},
  keywordstyle=\color{magenta},
  numberstyle=\tiny\color{codegray},
  stringstyle=\color{codepurple},
  basicstyle=\ttfamily\footnotesize\tiny,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  keepspaces=true,
  numbers=left,
  numbersep=5pt,
  showspaces=false,
  showstringspaces=false,
  showtabs=false,
  tabsize=2
}

\lstset{style=mystyle}
\usetheme{default}

\title{Efficient Data Serialization with Protocol Buffers}
\author{Andrey Rusakov}
\date{\today}

\def\code#1{\texttt{#1}}

\begin{document}

\begin{frame}
\titlepage
\end{frame}

% Introduction
\begin{frame}{Introduction}
\centering
\includegraphics[width=5cm]{gmail-proto}
\includegraphics[angle=45,width=4cm]{planet-header}
\end{frame}

% Size comparisons
\begin{frame}[fragile]{Overview}
  \begin{tikzpicture}[node distance=2.5cm]\tiny
    \node (proto) [process] {Proto file defines data structure};
    \node (parsed) [maybe, dashed, right of=proto] {Parsed protobuf file };
    \node (lang) [process, right of=parsed] {Language-specific code };
    \node (bincode) [final, right of=lang] {Binary data};
  \end{tikzpicture}
\end{frame}

\begin{frame}[fragile]{Proto file: Syntax}
\begin{lstlisting}[caption={Typical protocol buffer file}]
syntax = "proto3";
package example;
option go_package = "demo/proto";

// Message
message Polygon {
  // Nested message with scalar field
  message Point {
    double x = 1;
    double y = 2;
  }
  // Repeated field (list)
  repeated Point vertex = 1;
  string epsg = 2;
}

// Enum definition
enum AreaType {
  UNKNOWN = 0;
  PUBLIC = 1;
  PRIVATE = 2;
}

message Area {
   repeated Polygon polygons = 1;
   AreaType areaType = 2;

  // Reserved fields
  reserved "location", "owner";
}
\end{lstlisting}
\end{frame}

% Syntax variants
\begin{frame}{Proto file: Syntax variants}
  \begin{center}
    \begin{tabular}{ l l }
      Proto 2 & Proto 3 \\
      \hline
      \code{required} and \code{optional} & everything is optional \\
      \code{default} values & no default values \\
      packed repeated opt-in & packed repeated by default \\
      extensions & no extensions \\
      enums can be unset & enums must have default zero value
    \end{tabular}
  \end{center}
\end{frame}

% Codegen
\begin{frame}[fragile]{Proto file: ``Editions''}
Feature flags control feature state, for example, the ``Opaque api''
\begin{lstlisting}[caption={Protobuf definition}]
edition = "2023";
import "google/protobuf/go_features.proto";
option features.(pb.go).api_level = API_OPAQUE;

message Object {
  string name = 1;
  int64 value = 2;
}
\end{lstlisting}

\begin{minipage}{.49\textwidth}
\begin{lstlisting}[language=go,caption={Mutable}]
obj := &dpb.Object{
  Id:     strptr("objectId"),
  Parent: strptr("objectParent"),
}
\end{lstlisting}
\end{minipage}
\begin{minipage}{.49\textwidth}
\begin{lstlisting}[language=go,caption={Immutable},numbers=none]
obj := dpb.Object_builder{
  Id:     strptr("objectId"),
  Parent: strptr("objectParent"),
}.Build()
\end{lstlisting}
\end{minipage}
\end{frame}

% Codegen
\begin{frame}[fragile]{Language-specific code: Go}
\begin{lstlisting}[language=go,caption={Create and access proto message in Go}]
swissBounds := &dpb.Area{
    AreaType: dpb.AreaType_PUBLIC,
    Polygons: []*dpb.Polygon{
        {
            Points: []*dpb.Polygon_Point{
                {X: 5.306396, Y: 45.660127},
                {X: 10.843506, Y: 45.660127},
                {X: 10.843506, Y: 47.798397},
                {X: 5.306396, Y: 47.798397},
                {X: 5.306396, Y: 45.660127},
            },
            Epsg: "2056",
        },
    },
}
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]{Language-specific code: Java}
\begin{lstlisting}[language=java,caption={Create and access proto message in Java}]
var swissBounds = Schema.Area.newBuilder()
    .setAreaType(Schema.AreaType.PUBLIC)
    .addPolygons(
        Polygon.newBuilder()
            .setEpsg("2056")
            .addPoints(Point.newBuilder().setX(5.306396).setY(45.660127))
            .addPoints(Point.newBuilder().setX(10.843506).setY(45.660127))
            .addPoints(Point.newBuilder().setX(10.843506).setY(47.798397))
            .addPoints(Point.newBuilder().setX(5.306396).setY(47.798397))
            .addPoints(Point.newBuilder().setX(5.306396).setY(45.660127)))
    .build();
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]{Language-specific code: Python}
\begin{lstlisting}[language=python,caption={Create and access proto message in Python}]
swissBounds = schema_pb2.Area(
    areaType=schema_pb2.PUBLIC,
    polygons=[
        schema_pb2.Polygon(
            points=[
                schema_pb2.Polygon.Point(x=0, y=0),
                schema_pb2.Polygon.Point(x=1, y=1),
            ],
            epsg="2056",
        ),
    ],
)
print(swissBounds)
\end{lstlisting}
\end{frame}

\begin{frame}{Limitations}
\begin{itemize}[label=\Sey{}]
\item Removing fields is difficult
\item Renaming fields is very difficult
\item Binary is difficult to debug
\item No schema file in the binary file
\item \textasciitilde2GiB size limit for a message in binary form
\end{itemize}
\end{frame}

\begin{frame}{Dealing with limitations}

\end{frame}

% TODO: color the cells
\begin{frame}{Similar projects}
  \begin{center}
    \begin{tabular}{ l l l l l l }
      Format & Schema & Code & Bin/Text & ZC\footnote[1]{ What is zerocopy? }  & Big Data \\
      \hline
      Apache Avro & + & + & +/+ & - & + \\
      Cap'n Proto & \textasciitilde & + & +/+ & + & \textasciitilde \\
      Flat Buffers & \textasciitilde & + & +/+ & + & \textasciitilde \\
      JSON Schema & + & - & -/+ & - & \textasciitilde \\
      Message pack & - & - & +/- & - & \textasciitilde
    \end{tabular}
  \end{center}
\end{frame}

% Conclusion
\begin{frame}{Conclusion}
But there is more...
\end{frame}

\begin{frame}{Protoc plugins}
Frame 4
\end{frame}

\begin{frame}{GRPC}
Examples
\end{frame}

\end{document}
